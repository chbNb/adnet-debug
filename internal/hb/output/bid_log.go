package output

import (
	"bytes"
	"strconv"
	"strings"
	"time"

	"gitlab.mobvista.com/ADN/adnet/internal/hb/constant"
	"gitlab.mobvista.com/ADN/adnet/internal/hb/helpers"
	"gitlab.mobvista.com/ADN/adnet/internal/mvutil"
)

func FormatBidLog(bidData *mvutil.ReqCtx, filterCode int, filterMsg string) string {
	var dspID string
	dspExt, err := bidData.ReqParams.GetDspExt()
	if err == nil {
		dspID = strconv.FormatInt(dspExt.DspId, 10)
	}
	var buf bytes.Buffer
	buf.WriteString(strconv.FormatInt(time.Now().Unix(), 10))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strconv.FormatInt(bidData.ReqParams.Param.PublisherID, 10))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strconv.FormatInt(bidData.ReqParams.Param.AppID, 10))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strconv.FormatInt(bidData.ReqParams.Param.UnitID, 10))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.Extra)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(constant.OpenApi)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(mvutil.GetAdTypeStr(bidData.ReqParams.Param.AdType))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(helpers.GetOs(bidData.ReqParams.Param.Platform))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strings.ToLower(bidData.ReqParams.Param.SDKVersion))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.AppVersionName)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.CountryCode)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strconv.FormatInt(bidData.ReqParams.Param.CityCode, 10))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strconv.Itoa(constant.APIOffer))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.Extchannel)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(dspID)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Token)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.RequestID)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.PriceBigDecimal)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strconv.Itoa(bidData.ReqParams.Nbr))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strconv.Itoa(filterCode))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString("0")
	buf.WriteString(constant.SplitterTab)
	buf.WriteString("0")
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.ClientIP)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(filterMsg)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.HBS2SBidID)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.TokenTimeStamp)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strconv.Itoa(bidData.ReqParams.BidIsNotUSDCur))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.BidCur)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strconv.FormatFloat(bidData.ReqParams.CurrencyPrice, 'f', 2, 64))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString("17")
	buf.WriteString(constant.SplitterTab)
	buf.WriteString("17:0:1")
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.OSVersion)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.Brand)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.Model)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.ScreenSize)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strconv.Itoa(bidData.ReqParams.Param.Orientation))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.Language)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strconv.Itoa(bidData.ReqParams.Param.NetworkType))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.MCC + bidData.ReqParams.Param.MNC)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.RemoteIP)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.ServerIP)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.IMEI)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.MAC)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.AndroidID)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.GAID)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.IDFA)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strconv.Itoa(bidData.ReqParams.FlowTagID))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strconv.Itoa(int(bidData.ReqParams.Param.AdNum)))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strconv.Itoa(bidData.ReqParams.Param.RandValue))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.AdBackendConfig)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString("")
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.DspExt)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString("17")
	buf.WriteString(constant.SplitterTab)
	buf.WriteString("")
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.PriceFactor)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strconv.Itoa(int(bidData.ReqParams.Param.HBBidTestMode)))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.BidFloorBigDecimal)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.RankerInfo)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.MediationName)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.Extra3)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.Extalgo)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.ExtAdxAlgo)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.ExtPlacementId)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.ExtData)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(mvutil.RawUrlEncode(bidData.ReqParams.Param.UserAgent))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.IDFV)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.UseDynamicTmax)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strconv.Itoa(bidData.ReqParams.Param.ExtDataInit.TmaxABTestTag))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strconv.FormatInt(bidData.ReqParams.Param.MasResponseTime, 10))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(strconv.Itoa(bidData.ReqParams.Param.RequestType))
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.ExtSysId)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.OAID)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.ExtpackageName)
	buf.WriteString(constant.SplitterTab)
	buf.WriteString(bidData.ReqParams.Param.ExtfinalPackageName)
	return buf.String()
}
